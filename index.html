<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Sheet Academy: Logistics Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.5) 1px, transparent 1px);
            background-size: 40px 40px;
            color: #e2e8f0;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* --- Grid Styles --- */
        .grid-header-col {
            background: #1e293b;
            color: #94a3b8;
            font-weight: 600;
            text-align: center;
            padding: 8px;
            border: 1px solid #334155;
            user-select: none;
        }

        .grid-header-row {
            background: #1e293b;
            color: #94a3b8;
            font-weight: 600;
            text-align: center;
            padding: 8px;
            border: 1px solid #334155;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-cell {
            background: #0f172a;
            border: 1px solid #334155;
            position: relative;
            transition: all 0.1s;
            cursor: text;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem; /* Slightly smaller font to fit more data */
            color: #f8fafc;
            overflow: hidden; /* Prevent overflow */
            white-space: nowrap;
        }

        .grid-cell:hover {
            border-color: #6366f1;
            z-index: 10;
        }

        /* Selection from Click */
        .grid-cell.selected {
            background: rgba(99, 102, 241, 0.15);
            border: 2px solid #6366f1; /* Indigo */
            z-index: 20;
        }

        /* Live Formula Highlight */
        .grid-cell.formula-ref {
            background: rgba(236, 72, 153, 0.15) !important; /* Pink tint */
            border: 2px dashed #ec4899 !important;
            z-index: 30;
        }

        /* Success Animation */
        @keyframes successFlash {
            0% { background-color: #22c55e; color: white; }
            100% { background-color: #0f172a; color: #f8fafc; }
        }
        .cell-success {
            animation: successFlash 1.5s ease-out;
        }

        /* Shake Animation */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Confetti/Galaxy Canvas */
        #effects-canvas, #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Custom Input Styling */
        .formula-input-wrapper:focus-within {
            box-shadow: 0 0 0 2px #6366f1;
        }

        /* Glass Modal */
        .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
        }
        
        /* Feedback Terminal Styling */
        .terminal-success { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .terminal-error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .terminal-warning { border-color: #eab308; background: rgba(234, 179, 8, 0.1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <canvas id="effects-canvas"></canvas>
    <canvas id="confetti"></canvas>
    
    <!-- Preloaded Audio Assets -->
    <audio id="end-sfx" src="https://github.com/Cleo876/LOGISTICS-COMMAND/raw/refs/heads/main/space-sfx.mp3" preload="auto"></audio>

    <!-- Header -->
    <header class="bg-slate-900/90 backdrop-blur border-b border-slate-700 p-4 flex justify-between items-center z-50 shadow-lg">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-500/20">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">LOGISTICS COMMAND <span class="text-indigo-400 text-sm font-mono">:: GRADE 9 MODULE</span></h1>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> SYSTEM ONLINE
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Mission Progress</div>
                <div class="font-mono text-indigo-300 font-bold text-lg">LEVEL <span id="level-display">1</span>/<span id="level-total">10</span></div>
            </div>
            <div class="h-8 w-px bg-slate-700"></div>
            <div class="text-right">
                <div class="text-xs text-slate-400 uppercase tracking-wider">Credits Earned</div>
                <div class="font-mono text-green-400 font-bold text-lg" id="score-display">0</div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar: Mission Intel -->
        <aside class="w-96 bg-slate-800 border-r border-slate-700 flex flex-col z-40 shadow-xl">
            <div class="p-6 flex-1 overflow-y-auto">
                
                <!-- Mission Card -->
                <div class="bg-slate-900 rounded-xl border border-slate-700 p-5 mb-6 shadow-inner">
                    <h2 class="text-indigo-400 text-xs font-bold uppercase tracking-widest mb-2 flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        Current Objective
                    </h2>
                    <h3 id="mission-title" class="text-white font-bold text-xl mb-3">Mission Title</h3>
                    <div id="mission-desc" class="text-slate-300 text-sm leading-relaxed space-y-3">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Reference Button -->
                <button onclick="toggleReference()" class="w-full mb-6 py-2 px-3 bg-indigo-900/30 hover:bg-indigo-900/50 text-indigo-300 text-xs font-bold rounded border border-indigo-500/30 flex items-center justify-between transition-colors group">
                    <span class="flex items-center gap-2">
                        <span class="bg-indigo-500 text-white w-5 h-5 rounded flex items-center justify-center text-[10px]">?</span>
                        FIELD MANUAL / FORMULAS
                    </span>
                    <span class="text-indigo-400 group-hover:translate-x-1 transition-transform">â†’</span>
                </button>

                <!-- Formula Bar -->
                <div class="mb-2">
                    <div class="flex justify-between items-baseline mb-1">
                        <label class="text-slate-400 text-xs font-bold uppercase">Formula Bar (fx)</label>
                        <span class="text-xs text-pink-400 italic" id="live-indicator">Waiting for input...</span>
                    </div>
                    <div class="formula-input-wrapper bg-slate-900 rounded-lg border border-slate-600 flex items-center overflow-hidden transition-all">
                        <div class="bg-slate-800 px-3 py-3 border-r border-slate-700 text-slate-400 font-mono font-bold select-none">fx</div>
                        <input type="text" id="formula-input" 
                            placeholder="Type formula here..." 
                            class="w-full bg-transparent text-white px-3 py-3 font-mono focus:outline-none placeholder-slate-600" 
                            autocomplete="off" spellcheck="false">
                    </div>
                    <div class="text-[10px] text-slate-500 mt-1 pl-1">
                        ðŸ’¡ Tip: Ranges highlight in <span class="text-pink-400 font-bold">PINK</span> as you type.
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-1 gap-3 mt-6">
                    <button onclick="checkAnswer()" class="group relative w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg shadow-indigo-900/20 transition-all overflow-hidden">
                        <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                        <span class="flex items-center justify-center gap-2">
                            EXECUTE FORMULA
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </span>
                    </button>
                </div>

                <!-- Feedback Terminal -->
                <div id="feedback-terminal" class="mt-6 hidden transition-all duration-300">
                    <div id="terminal-box" class="rounded p-3 font-mono text-xs border shadow-inner bg-slate-900 border-slate-700">
                        <div class="flex gap-2 mb-1">
                            <span id="terminal-icon" class="text-slate-500">âžœ</span>
                            <span class="text-slate-400">system_diagnostic...</span>
                        </div>
                        <div id="feedback-msg" class="text-slate-300 font-bold leading-relaxed">Ready.</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content: The Grid -->
        <main class="flex-1 p-8 overflow-auto bg-slate-900 flex items-start justify-center">
            
            <div class="w-full max-w-3xl">
                <!-- Dataset Title -->
                <div class="flex justify-between items-end mb-2 px-1">
                    <div class="text-slate-400 font-mono text-xs uppercase tracking-wider">File: <span class="text-white" id="sheet-name">SUPPLY_MANIFEST.xlsx</span></div>
                    <div class="text-slate-500 text-xs">Auto-Save: ON</div>
                </div>

                <!-- The Spreadsheet -->
                <div class="bg-slate-800 rounded-lg p-1 border border-slate-600 shadow-2xl">
                    <div id="spreadsheet-container" class="grid gap-px bg-slate-700 rounded overflow-hidden">
                        <!-- Grid Generated via JS -->
                    </div>
                </div>
                
                <!-- Small Static Legend -->
                <div class="mt-6 flex gap-4 text-xs text-slate-500 justify-center">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-slate-700 border border-slate-500 rounded"></span> 
                        <span>Normal Cell</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-indigo-500/20 border border-indigo-500 rounded"></span> 
                        <span>Selection</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-pink-500/20 border border-pink-500 border-dashed rounded"></span> 
                        <span>Formula Ref</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Reference Guide Modal -->
        <div id="ref-modal" class="fixed inset-0 z-[210] bg-slate-900/80 hidden flex items-center justify-center backdrop-blur-sm p-4 transition-opacity opacity-0 pointer-events-none" onclick="toggleReference()">
            <div class="glass-panel border border-slate-600 rounded-xl max-w-2xl w-full shadow-2xl transform scale-95 transition-transform duration-200" id="ref-content" onclick="event.stopPropagation()">
                
                <!-- Modal Header -->
                <div class="bg-slate-800/50 p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-white font-bold text-lg flex items-center gap-3">
                        <div class="bg-indigo-500 p-1 rounded text-white">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </div>
                        Field Manual: Formulas
                    </h3>
                    <button onclick="toggleReference()" class="text-slate-400 hover:text-white transition-colors">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto max-h-[70vh]">
                    <!-- Basic Operations -->
                    <div class="space-y-3">
                        <h4 class="text-indigo-400 text-xs font-bold uppercase tracking-wider border-b border-slate-700 pb-1">Basic Operations</h4>
                        <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                            <div class="flex justify-between mb-1"><span class="text-white font-mono font-bold">+</span> <span class="text-slate-400 text-xs">Addition</span></div>
                            <code class="text-green-400 text-xs block bg-black/30 p-1 rounded">=A1 + B1</code>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                            <div class="flex justify-between mb-1"><span class="text-white font-mono font-bold">-</span> <span class="text-slate-400 text-xs">Subtraction</span></div>
                            <code class="text-green-400 text-xs block bg-black/30 p-1 rounded">=A1 - B1</code>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                            <div class="flex justify-between mb-1"><span class="text-white font-mono font-bold">*</span> <span class="text-slate-400 text-xs">Multiplication</span></div>
                            <code class="text-green-400 text-xs block bg-black/30 p-1 rounded">=A1 * B1</code>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                            <div class="flex justify-between mb-1"><span class="text-white font-mono font-bold">/</span> <span class="text-slate-400 text-xs">Division</span></div>
                            <code class="text-green-400 text-xs block bg-black/30 p-1 rounded">=A1 / B1</code>
                        </div>
                    </div>
                    <!-- Key Functions -->
                     <div class="space-y-3">
                        <h4 class="text-indigo-400 text-xs font-bold uppercase tracking-wider border-b border-slate-700 pb-1">Key Functions</h4>
                        <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                            <strong class="text-white text-sm">SUM</strong>
                            <p class="text-slate-400 text-xs mb-1">Adds a range.</p>
                            <code class="text-green-400 text-xs block bg-black/30 p-1 rounded font-mono">=SUM(A1:A5)</code>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                            <strong class="text-white text-sm">AVERAGE</strong>
                            <p class="text-slate-400 text-xs mb-1">Finds the mean.</p>
                            <code class="text-green-400 text-xs block bg-black/30 p-1 rounded font-mono">=AVERAGE(A1:A5)</code>
                        </div>
                         <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                            <strong class="text-white text-sm">MAX / MIN</strong>
                            <p class="text-slate-400 text-xs mb-1">Highest or Lowest.</p>
                            <code class="text-green-400 text-xs block bg-black/30 p-1 rounded font-mono">=MAX(A1:A5)</code>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800/50 p-3 border-t border-slate-700 text-center">
                    <button onclick="toggleReference()" class="text-xs text-slate-400 hover:text-white underline">Close Manual</button>
                </div>
            </div>
        </div>

        <!-- Success Modal (Also used for Final) -->
        <div id="modal" class="fixed inset-0 z-[200] bg-slate-900/90 hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-slate-800 border border-slate-600 rounded-2xl p-8 max-w-md w-full text-center shadow-2xl transform scale-95 transition-all" id="modal-content">
                <div class="w-16 h-16 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 border border-green-500/50">
                    âœ“
                </div>
                <h2 class="text-2xl font-bold text-white mb-2" id="modal-title">Calculation Correct</h2>
                <p class="text-slate-400 mb-6" id="modal-message">Data verified. Systems optimal.</p>
                <button onclick="nextLevel()" class="w-full bg-white hover:bg-slate-200 text-slate-900 font-bold py-3 rounded-xl transition-colors" id="modal-btn">
                    Proceed to Next Task
                </button>
            </div>
        </div>
        
        <!-- End Game Modal (Special) -->
        <div id="end-modal" class="fixed inset-0 z-[220] bg-transparent hidden flex items-center justify-center pointer-events-auto">
             <div class="bg-slate-900/90 border-2 border-indigo-500 rounded-2xl p-10 max-w-lg w-full text-center shadow-[0_0_50px_rgba(99,102,241,0.5)] transform scale-0 opacity-0 transition-all duration-1000" id="end-content">
                <div class="w-24 h-24 bg-indigo-500 text-white rounded-full flex items-center justify-center text-5xl mx-auto mb-6 shadow-[0_0_20px_rgba(99,102,241,0.8)] animate-pulse">
                    ðŸš€
                </div>
                <h2 class="text-4xl font-black text-white mb-4 tracking-tight">MISSION ACCOMPLISHED</h2>
                <p class="text-indigo-200 text-lg mb-8 leading-relaxed">
                    Cadet, your command of logistics data is exceptional. The fleet is supplied, systems are stable, and we are ready for hyperspace.
                </p>
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 mb-6">
                    <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">Final Score</div>
                    <div class="text-3xl font-mono text-green-400 font-bold" id="final-score">0</div>
                </div>
                <button onclick="location.reload()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all transform hover:scale-105">
                    Play Again
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Config ---
        const ROWS = 8;
        const COLS = 5; 
        const COL_HEADERS = ['A', 'B', 'C', 'D', 'E'];
        
        let currentLevel = 0;
        let score = 0;
        let sheetData = {}; 

        // --- Audio System ---
        const successSfx = new Audio('https://github.com/Cleo876/Quick-Bites/raw/refs/heads/main/interface-sfx.wav');
        successSfx.volume = 0.6;
        const errorSfx = new Audio('https://github.com/Cleo876/Quick-Bites/raw/refs/heads/main/incorrect-sfx.wav');
        errorSfx.volume = 0.6; 
        
        // End Game Audio (Initialized by HTML)
        // This ensures it is preloaded and ready for instant playback

        function playSuccess() {
            successSfx.currentTime = 0;
            successSfx.play().catch(e => console.warn("Audio playback failed:", e));
        }

        function playError() {
            errorSfx.currentTime = 0;
            errorSfx.play().catch(e => console.warn("Audio playback failed:", e));
        }

        const levels = [
            // Level 1: Multiplication
            {
                title: "Inventory Valuation",
                sheetName: "CARGO_HOLD_ALPHA.xlsx",
                desc: `
                    <p>Cadet, we have <strong>Fuel Pods</strong> in storage. We need the <strong>Total Value</strong>.</p>
                    <ul class="list-disc pl-4 mt-2 text-slate-400 text-xs space-y-1">
                        <li>Column B: Quantity</li>
                        <li>Column C: Price Per Unit</li>
                    </ul>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Calculate value of Fuel Pods (Qty Ã— Price).</p>
                `,
                setup: {
                    "A1": "ITEM", "B1": "QTY", "C1": "PRICE", "D1": "STATUS", "E1": "BIN #",
                    "A2": "Fuel Pod", "B2": 50, "C2": 20, "D2": "Secure", "E2": "A-101",
                    "A3": "Rations", "B3": 100, "C3": 5, "D3": "Ok", "E3": "B-202",
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Validation: Check math AND check specific cell refs (B2, C2) are used
                    const validFormula = (clean.includes("B2*C2") || clean.includes("C2*B2") || clean.includes("PRODUCT(B2,C2)"));
                    return validFormula && val === 1000;
                },
                hint: "Multiply the Quantity cell by the Price cell using the asterisk (*)."
            },
            // Level 2: SUM (Vertical)
            {
                title: "Expense Report",
                sheetName: "ENGINE_REPAIRS.xlsx",
                desc: `
                    <p>The Commander needs the <strong>Total Cost</strong> of all repairs from the battle expedition.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Calculate the total cost of the repair items listed.</p>
                `,
                setup: {
                    "A1": "PART", "B1": "COST", "C1": "TECH ID", "D1": "DATE",
                    "A2": "Valve", "B2": 450, "C2": "X-99", "D2": "12/05",
                    "A3": "Seal", "B3": 120, "C2": "X-99", "D3": "12/06",
                    "A4": "Bolt", "B4": 30, "C2": "Y-40", "D4": "12/06",
                    "A5": "Labor", "B5": 200, "C2": "Y-40", "D5": "12/07"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict check: Must use SUM and the range B2:B5
                    const validRange = clean.includes("B2:B5");
                    return clean.startsWith("=SUM(") && validRange && val === 800;
                },
                hint: "Use =SUM(start:end) on the cost data."
            },
            // Level 3: Subtraction
            {
                title: "Profit Analysis",
                sheetName: "TRADING_POST.xlsx",
                desc: `
                    <p>We need to determine our Net Profit from the Expedition, this will be how we cover the cost of the repairs and see how much we made from the expedition.</p>
                    <ul class="list-disc pl-4 mt-2 text-slate-400 text-xs space-y-1">
                        <li>B2: Revenue</li>
                        <li>B3: Expenses</li>
                    </ul>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Calculate Profit (Revenue - Expenses).</p>
                `,
                setup: {
                    "A1": "METRIC", "B1": "VALUE", "C1": "NOTES",
                    "A2": "Revenue", "B2": 5000, "C2": "Credits",
                    "A3": "Expenses", "B3": 3200, "C3": "Credits",
                    "A4": "Profit", "B4": null, "C4": "Credits"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    return (clean.includes("B2-B3")) && val === 1800;
                },
                hint: "Subtract Expenses from Revenue."
            },
            // Level 4: MAX
            {
                title: "Performance Review",
                sheetName: "PILOT_SCORES.xlsx",
                desc: `
                    <p>Identify the <strong>highest score</strong> recorded for each of these pilots to see who is the <strong>top performer</strong> currently.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Use a function to identify the highest pilot score recorded.</p>
                `,
                setup: {
                    "A1": "PILOT", "B1": "RANK", "C1": "SCORE", "D1": "EXP",
                    "A2": "Viper", "B2": "Lt.", "C2": 88, "D2": "2yr",
                    "A3": "Starbuck", "B3": "Cpt.", "C3": 95, "D3": "5yr",
                    "A4": "Apollo", "B4": "Cpt.", "C4": 92, "D4": "4yr",
                    "A5": "Boomer", "B5": "Lt.", "C5": 85, "D5": "3yr",
                    "A6": "Helo", "B6": "Sgt.", "C6": 70, "D6": "1yr"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict check: MAX on C2:C6
                    const validRange = clean.includes("C2:C6");
                    return clean.startsWith("=MAX(") && validRange && val === 95;
                },
                hint: "Use the =MAX() function on the score range."
            },
            // Level 5: AVERAGE (Vertical)
            {
                title: "Advanced Logistics",
                sheetName: "FLEET_FUEL.xlsx",
                desc: `
                    <p>We need the <strong>Average</strong> fuel level of our 3 main ships.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Calculate the average fuel percentage across the fleet.</p>
                `,
                setup: {
                    "A1": "SHIP", "B1": "FUEL %", "C1": "CLASS", "D1": "DOCK",
                    "A2": "Alpha", "B2": 80, "C2": "Fighter", "D2": "D-1",
                    "A3": "Beta", "B3": 60, "C2": "Bomber", "D2": "D-2",
                    "A4": "Gamma", "B4": 100, "C2": "Scout", "D2": "D-3"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict check: AVERAGE on B2:B4
                    const validRange = clean.includes("B2:B4");
                    return clean.startsWith("=AVERAGE(") && validRange && val === 80;
                },
                hint: "Use =AVERAGE(start:end) on the fuel data."
            },
            // Level 6: MIN (System Cooling)
            {
                title: "System Cooling",
                sheetName: "REACTOR_CORE.xlsx",
                desc: `
                    <p>Warning: One sector is dropping to dangerous temperatures. We need to find the <strong>lowest</strong> temp reading to direct heat.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Find the minimum temperature reading to locate the cooling leak.</p>
                `,
                setup: {
                    "A1": "SECTOR", "B1": "TEMP (K)", "C1": "TREND",
                    "A2": "North", "B2": 350, "C2": "Stable",
                    "A3": "East", "B3": 210, "C3": "Falling",
                    "A4": "South", "B4": 150, "C4": "Crit-Low",
                    "A5": "West", "B5": 310, "C5": "Stable",
                    "A6": "Core", "B6": 400, "C6": "Rising"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict check: MIN on B2:B6
                    const validRange = clean.includes("B2:B6");
                    return clean.startsWith("=MIN(") && validRange && val === 150;
                },
                hint: "Use =MIN(range) to find the smallest number."
            },
            // Level 7: PRODUCT (Hyperdrive Output) - REWORDED
            {
                title: "Hyperdrive Output",
                sheetName: "POWER_GRID.xlsx",
                desc: `
                    <p>To initiate the jump, the Hyperdrive needs the <strong>combined product</strong> of the Main, Aux, and Boost power couplings.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Determine the total amplified power output by multiplying the three power coupling values.</p>
                `,
                setup: {
                    "A1": "PART", "B1": "STATUS", "C1": "POWER", "D1": "FREQ",
                    "A2": "Main", "B2": "Online", "C2": 5, "D2": "60Hz",
                    "A3": "Aux", "B3": "Online", "C3": 2, "D3": "60Hz",
                    "A4": "Boost", "B4": "Ready", "C4": 10, "D4": "120Hz"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict check: C2, C3, C4 or C2:C4
                    const hasCells = clean.includes("C2") && clean.includes("C3") && clean.includes("C4");
                    const hasRange = clean.includes("C2:C4");
                    return (clean.startsWith("=PRODUCT(") || clean.includes("*")) && (hasCells || hasRange) && val === 100;
                },
                hint: "Use =PRODUCT(range) or multiply the cells manually."
            },
            // Level 8: SUM (Horizontal) - REWORDED & FIXED
            {
                title: "Quarterly Yield",
                sheetName: "MINING_OPS.xlsx",
                desc: `
                    <p>Mining Command needs a report on <strong>Sector 7</strong>. We need to know the <strong>Total Yield</strong> generated across the first three quarters.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Calculate the sum of yields for Sector 7.</p>
                `,
                setup: {
                    "A1": "SECTOR", "B1": "Q1", "C1": "Q2", "D1": "Q3", "E1": "TYPE",
                    "A2": "Sec-7", "B2": 150, "C2": 200, "D2": 150, "E2": "Iron",
                    "A3": "Sec-8", "B3": 50,  "C3": 60,  "D3": 40, "E3": "Gold"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict check: Horizontal Range B2:D2
                    const validRange = clean.includes("B2:D2");
                    return clean.startsWith("=SUM(") && validRange && val === 500;
                },
                hint: "Ranges can be sideways! Use =SUM(start:end)"
            },
            // Level 9: Division (Efficiency Ratio) - REVISED FOR CLARITY
            {
                title: "Efficiency Ratio",
                sheetName: "ENGINEERING.xlsx",
                desc: `
                    <p>Engineering requires a diagnostic on Solar Panel <strong>X-1</strong>. System efficiency is defined as the amount of <strong>Output</strong> generated <strong>per unit of Input</strong>.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Calculate the efficiency ratio for Panel X-1.</p>
                `,
                setup: {
                    "A1": "PANEL", "B1": "OUT", "C1": "IN", "D1": "HEALTH",
                    "A2": "X-1", "B2": 800, "C2": 1000, "D2": "98%",
                    "A3": "X-2", "B3": 500, "C3": 1000, "D3": "45%"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict Check: B2/C2
                    const validCells = clean.includes("B2") && clean.includes("C2");
                    return (clean.includes("B2/C2") || clean.includes("QUOTIENT")) && validCells && val === 0.8;
                },
                hint: "Divide Output by Input using the / symbol."
            },
            // Level 10: AVERAGE (Block Range) - REWORDED
            {
                title: "Grid Stabilization",
                sheetName: "SHIELD_ARRAY.xlsx",
                desc: `
                    <p><strong>CRITICAL ALERT:</strong> The Shield Array is fluctuating! We need to balance the grid using the <strong>Average</strong> energy level of all active emitters.</p>
                    <p class="mt-3 text-yellow-300 font-bold">Task: Calculate the average stability for the entire block of emitters.</p>
                `,
                setup: {
                    "A1": "ZONE", "B1": "L", "C1": "R", "D1": "MOD",
                    "A2": "Top", "B2": 80, "C2": 90, "D2": "Alpha",
                    "A3": "Mid", "B3": 85, "C3": 95, "D3": "Beta",
                    "A4": "Bot", "B4": 75, "C4": 85, "D4": "Gamma"
                },
                validate: (formula, val) => {
                    const clean = formula.replace(/\s/g, '').toUpperCase();
                    // Strict check: 2D Range B2:C4
                    const validRange = clean.includes("B2:C4");
                    return clean.startsWith("=AVERAGE(") && validRange && val === 85;
                },
                hint: "Select the whole block like a box: =AVERAGE(TopLeft:BottomRight)"
            }
        ];

        function init() {
            createGrid();
            document.getElementById('level-total').textContent = levels.length;
            loadLevel(0);
            
            document.getElementById('formula-input').addEventListener('input', (e) => {
                updateLiveHighlights(e.target.value);
            });
        }

        function createGrid() {
            const container = document.getElementById('spreadsheet-container');
            container.style.gridTemplateColumns = `40px repeat(${COLS}, 1fr)`;

            const corner = document.createElement('div');
            corner.className = 'grid-header-col';
            container.appendChild(corner);

            COL_HEADERS.forEach(char => {
                const h = document.createElement('div');
                h.className = 'grid-header-col';
                h.textContent = char;
                container.appendChild(h);
            });

            for (let r = 1; r <= ROWS; r++) {
                const rh = document.createElement('div');
                rh.className = 'grid-header-row';
                rh.textContent = r;
                container.appendChild(rh);

                for (let c = 0; c < COLS; c++) {
                    const colChar = COL_HEADERS[c];
                    const cellId = `${colChar}${r}`;
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.id = `cell-${cellId}`;
                    cell.dataset.id = cellId;
                    cell.onclick = () => insertCellRef(cellId);
                    container.appendChild(cell);
                }
            }
        }

        function loadLevel(idx) {
            currentLevel = idx;
            const lvl = levels[currentLevel];

            document.getElementById('level-display').textContent = currentLevel + 1;
            document.getElementById('mission-title').textContent = lvl.title;
            document.getElementById('mission-desc').innerHTML = lvl.desc;
            document.getElementById('sheet-name').textContent = lvl.sheetName;
            
            const input = document.getElementById('formula-input');
            input.value = "";
            input.focus();
            hideFeedback();
            updateLiveHighlights("");

            sheetData = { ...lvl.setup };
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.textContent = '';
                cell.className = 'grid-cell'; 
                const id = cell.dataset.id;
                if (sheetData[id] !== undefined && sheetData[id] !== null) {
                    cell.textContent = sheetData[id];
                    if (id.endsWith('1') || id.startsWith('A')) {
                        cell.style.color = '#94a3b8'; 
                        if(typeof sheetData[id] === 'number') cell.style.color = '#38bdf8'; 
                    } else {
                        cell.style.color = '#38bdf8'; 
                    }
                    if (isNaN(sheetData[id])) cell.style.fontWeight = 'bold';
                }
            });
        }

        function updateLiveHighlights(text) {
            document.querySelectorAll('.formula-ref').forEach(el => el.classList.remove('formula-ref'));
            const indicator = document.getElementById('live-indicator');

            if (!text.startsWith('=')) {
                indicator.textContent = "Start with '=' to write a formula";
                indicator.className = "text-xs text-slate-500 italic";
                return;
            }

            indicator.textContent = "Analyzing grid references...";
            indicator.className = "text-xs text-pink-400 font-mono animate-pulse";

            const rangeRegex = /([A-E][1-8]):([A-E][1-8])/gi;
            const cellRegex = /\b([A-E][1-8])\b/gi;

            let cleanText = text.toUpperCase();
            let match;
            
            while ((match = rangeRegex.exec(cleanText)) !== null) {
                const ids = expandRange(match[1], match[2]);
                ids.forEach(id => highlightCell(id));
            }

            let textWithoutRanges = cleanText.replace(rangeRegex, '');
            while ((match = cellRegex.exec(textWithoutRanges)) !== null) {
                highlightCell(match[1]);
            }
        }

        function highlightCell(id) {
            const cell = document.getElementById(`cell-${id}`);
            if (cell) cell.classList.add('formula-ref');
        }

        function expandRange(start, end) {
            const startCol = COL_HEADERS.indexOf(start.charAt(0));
            const startRow = parseInt(start.substring(1));
            const endCol = COL_HEADERS.indexOf(end.charAt(0));
            const endRow = parseInt(end.substring(1));

            const cMin = Math.min(startCol, endCol);
            const cMax = Math.max(startCol, endCol);
            const rMin = Math.min(startRow, endRow);
            const rMax = Math.max(startRow, endRow);

            let cells = [];
            for (let c = cMin; c <= cMax; c++) {
                for (let r = rMin; r <= rMax; r++) {
                    cells.push(`${COL_HEADERS[c]}${r}`);
                }
            }
            return cells;
        }

        function insertCellRef(id) {
            const input = document.getElementById('formula-input');
            input.value += id;
            input.focus();
            updateLiveHighlights(input.value);
        }

        // --- Visual Feedback ---
        function shakeGrid() {
            const grid = document.getElementById('spreadsheet-container');
            grid.classList.remove('shake');
            void grid.offsetWidth; // Trigger reflow
            grid.classList.add('shake');
        }

        function showFeedback(msg, type = "default") {
            const terminal = document.getElementById('feedback-terminal');
            const box = document.getElementById('terminal-box');
            const icon = document.getElementById('terminal-icon');
            const text = document.getElementById('feedback-msg');

            terminal.classList.remove('hidden');
            
            // Reset classes
            box.className = "rounded p-3 font-mono text-xs border shadow-inner transition-colors duration-300";
            
            if (type === "error") {
                box.classList.add('terminal-error', 'border-red-500/50', 'text-red-200');
                icon.textContent = "âœ–";
                icon.className = "text-red-400 font-bold";
                shakeGrid(); 
                playError(); 
            } else if (type === "warning") {
                box.classList.add('terminal-warning', 'border-yellow-500/50', 'text-yellow-200');
                icon.textContent = "âš ";
                icon.className = "text-yellow-400 font-bold";
                shakeGrid(); 
                playError();
            } else if (type === "success") {
                box.classList.add('terminal-success', 'border-green-500/50', 'text-green-200');
                icon.textContent = "âœ“";
                icon.className = "text-green-400 font-bold";
            } else {
                box.classList.add('bg-slate-900', 'border-slate-700', 'text-slate-300');
                icon.textContent = "âžœ";
                icon.className = "text-slate-500";
            }

            text.textContent = msg;
        }

        function hideFeedback() {
             document.getElementById('feedback-terminal').classList.add('hidden');
        }

        function analyzeMistake(formula, calcVal, level) {
            if (!/[A-E]/.test(formula)) {
                return "Manual entry detected. A Commander uses cell references (e.g. A1) to automate the ship, not hardcoded numbers.";
            }

            if (level.title === "Inventory Valuation") {
                if (formula.includes('+')) return "You are adding the supplies. To find total value, you must Multiply (Quantity * Price).";
            }
            if (level.title === "Expense Report") {
                if (calcVal === 0) return "The result is zero. Did you select the cells with numbers in them?";
            }
            if (level.title === "Profit Analysis") {
                if (calcVal === 8200) return "You added Expenses to Revenue. Profit is Revenue MINUS Expenses.";
            }
            if (level.title === "Advanced Logistics") { 
                if (calcVal === 240) return "That number is too high. You calculated the Total (SUM). We need the AVERAGE.";
            }

            return `Calculated result: ${calcVal}. This does not match the mission objective. Check your formula logic.`;
        }

        function checkAnswer() {
            const inputRaw = document.getElementById('formula-input').value.trim();
            const lvl = levels[currentLevel];

            if (inputRaw.replace(/\s/g, '').toUpperCase() === '=WIN(A1:C1)') {
                showFeedback("COMMAND OVERRIDE ACCEPTED: SKIPPING TO FINAL EVALUATION.", "success");
                score = 9999;
                document.getElementById('score-display').textContent = score;
                celebrate();
                // Audio handled by nextLevel logic, but we need to fast track
                // Trigger audio instantly for win
                const endAudio = document.getElementById('end-sfx');
                if(endAudio) { endAudio.currentTime = 0; endAudio.play().catch(e => console.warn(e)); }
                
                setTimeout(() => {
                    currentLevel = levels.length; 
                    nextLevel();
                }, 1500);
                return;
            }
            
            if (!inputRaw.startsWith('=')) {
                showFeedback("Protocol Violation: All formulas must begin with an equals sign (=).", "error");
                return;
            }

            const openP = (inputRaw.match(/\(/g) || []).length;
            const closeP = (inputRaw.match(/\)/g) || []).length;
            if (openP !== closeP) {
                showFeedback("Syntax Alert: Unmatched parentheses. Make sure every '(' has a closing ')'.", "warning");
                return;
            }

            try {
                let formula = inputRaw.toUpperCase().substring(1).trim(); 
                
                // Gibberish Check
                let checkStr = formula;
                const validFuncs = ['SUM', 'AVERAGE', 'MAX', 'MIN', 'PRODUCT'];
                validFuncs.forEach(fn => { checkStr = checkStr.replace(new RegExp(fn, 'g'), ''); });
                checkStr = checkStr.replace(/[A-E][1-8]/g, '');
                checkStr = checkStr.replace(/[0-9+\-*/().:,\s]/g, '');
                if (checkStr.length > 0) { throw new Error("Unknown Command: " + checkStr); }

                let calculatedValue = 0;

                if (formula.startsWith('SUM(')) {
                    const rangePart = formula.match(/SUM\((.*)\)/);
                    if (!rangePart) throw new Error("Empty SUM function");
                    const values = getValuesFromRangeString(rangePart[1]);
                    calculatedValue = values.reduce((a, b) => a + b, 0);
                } 
                else if (formula.startsWith('AVERAGE(')) {
                    const rangePart = formula.match(/AVERAGE\((.*)\)/);
                    if (!rangePart) throw new Error("Empty AVERAGE function");
                    const values = getValuesFromRangeString(rangePart[1]);
                    calculatedValue = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                }
                else if (formula.startsWith('MAX(')) {
                    const rangePart = formula.match(/MAX\((.*)\)/);
                    if (!rangePart) throw new Error("Empty MAX function");
                    const values = getValuesFromRangeString(rangePart[1]);
                    calculatedValue = values.length ? Math.max(...values) : 0;
                }
                else if (formula.startsWith('MIN(')) {
                    const rangePart = formula.match(/MIN\((.*)\)/);
                    if (!rangePart) throw new Error("Empty MIN function");
                    const values = getValuesFromRangeString(rangePart[1]);
                    calculatedValue = values.length ? Math.min(...values) : 0;
                }
                else if (formula.startsWith('PRODUCT(')) {
                    const rangePart = formula.match(/PRODUCT\((.*)\)/);
                    if (!rangePart) throw new Error("Empty PRODUCT function");
                    const values = getValuesFromRangeString(rangePart[1]);
                    calculatedValue = values.length ? values.reduce((a, b) => a * b, 1) : 0;
                }
                else {
                    const parsed = formula.replace(/[A-E][1-8]/g, (match) => {
                        const val = sheetData[match];
                        return (val !== undefined && typeof val === 'number') ? val : 0;
                    });
                    
                    if (/[^0-9+\-*/().\s]/.test(parsed)) {
                         throw new Error("Invalid characters in formula");
                    }
                    calculatedValue = new Function('return ' + parsed)();
                }

                calculatedValue = Math.round(calculatedValue * 100) / 100;

                if (lvl.validate(inputRaw, calculatedValue)) {
                    showFeedback(`Success! Result: ${calculatedValue}. Data verified.`, "success");
                    score += 250;
                    document.getElementById('score-display').textContent = score;
                    celebrate();
                    
                    setTimeout(() => {
                        playSuccess();
                        document.getElementById('modal').classList.remove('hidden');
                    }, 1000);
                } else {
                    const helpMsg = analyzeMistake(formula, calculatedValue, lvl);
                    showFeedback(helpMsg, "warning");
                }

            } catch (e) {
                let niceError = "Syntax Error: The computer could not understand your formula.";
                if (e.message.includes("Unknown Command")) {
                     const gibberish = e.message.split(":")[1] || "";
                     niceError = `System Error: Unknown command or reference "${gibberish}". Check spelling.`;
                } else if (e.message.includes("Invalid characters")) {
                    niceError = "Syntax Error: You typed something that isn't a valid math symbol or cell reference.";
                }
                showFeedback(niceError, "error");
            }
        }

        function getValuesFromRangeString(rangeStr) {
            let values = [];
            rangeStr = rangeStr.replace(/\s/g, ''); 
            const tokens = rangeStr.split(','); 
            
            tokens.forEach(token => {
                if (token.includes(':')) {
                    const parts = token.split(':');
                    if (parts.length === 2) {
                        const ids = expandRange(parts[0], parts[1]);
                        ids.forEach(id => {
                            if (typeof sheetData[id] === 'number') values.push(sheetData[id]);
                        });
                    }
                } else {
                    if (typeof sheetData[token] === 'number') values.push(sheetData[token]);
                }
            });
            return values;
        }

        function nextLevel() {
             document.getElementById('modal').classList.add('hidden');
             
             if (currentLevel < levels.length - 1) {
                 loadLevel(currentLevel + 1);
             } else {
                 // END GAME SEQUENCE
                 // 1. TRIGGER AUDIO IMMEDIATELY - FIRST ACTION
                 const endAudio = document.getElementById('end-sfx');
                 if(endAudio) {
                     endAudio.currentTime = 0;
                     endAudio.play().catch(e => console.warn("End audio blocked:", e));
                 }
                 // 2. Start Animation
                 playGalaxyAnimation();
             }
        }

        // --- End Game Animation Logic ---
        let galaxyReqId;
        
        function playGalaxyAnimation() {
            const canvas = document.getElementById('effects-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            let stars = [];
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Create "Warp Speed" stars
            for(let i=0; i<300; i++) {
                stars.push({
                    x: (Math.random() - 0.5) * canvas.width * 2,
                    y: (Math.random() - 0.5) * canvas.height * 2,
                    z: Math.random() * canvas.width
                });
            }

            function drawGalaxy() {
                // Clear with trail effect
                ctx.fillStyle = 'rgba(15, 23, 42, 0.3)'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                stars.forEach(star => {
                    // Move star towards camera
                    star.z -= 15;
                    if(star.z <= 0) {
                        star.z = canvas.width;
                        star.x = (Math.random() - 0.5) * canvas.width * 2;
                        star.y = (Math.random() - 0.5) * canvas.height * 2;
                    }
                    
                    // Project 3D pos to 2D
                    const k = 128.0 / star.z;
                    const px = star.x * k + centerX;
                    const py = star.y * k + centerY;
                    
                    if(px >= 0 && px <= canvas.width && py >= 0 && py <= canvas.height) {
                        const size = (1 - star.z / canvas.width) * 4;
                        const shade = parseInt((1 - star.z / canvas.width) * 255);
                        ctx.fillStyle = `rgb(${shade},${shade},${255})`;
                        ctx.beginPath();
                        ctx.arc(px, py, size, 0, Math.PI*2);
                        ctx.fill();
                    }
                });
                
                galaxyReqId = requestAnimationFrame(drawGalaxy);
            }
            
            // Start Animation
            drawGalaxy();
            
            // Show Final Modal after 3.5 seconds of animation
            setTimeout(() => {
                cancelAnimationFrame(galaxyReqId);
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clean up
                
                const endModal = document.getElementById('end-modal');
                const endContent = document.getElementById('end-content');
                document.getElementById('final-score').textContent = score;
                
                endModal.classList.remove('hidden');
                // Trigger CSS transition
                requestAnimationFrame(() => {
                    endContent.classList.remove('scale-0', 'opacity-0');
                    endContent.classList.add('scale-100', 'opacity-100');
                });
                
                celebrate(); // One last confetti blast
            }, 3500);
        }

        function toggleReference() {
            const modal = document.getElementById('ref-modal');
            const content = document.getElementById('ref-content');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden', 'pointer-events-none');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
            } else {
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden', 'pointer-events-none');
                }, 200);
            }
        }

        // --- Standard Effects ---
        const confettiCanvas = document.getElementById('confetti');
        const ctx = confettiCanvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function celebrate() {
            for(let i=0; i<100; i++) {
                particles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    life: 100
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            particles.forEach((p, index) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.life--;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 6, 6);
                if(p.life <= 0) particles.splice(index, 1);
            });
            if(particles.length > 0) requestAnimationFrame(animateConfetti);
        }

        init();
    </script>
</body>
</html>
